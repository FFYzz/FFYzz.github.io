<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/timg.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon64.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon64.png">
  <link rel="mask-icon" href="/images/icon64.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ffyzz.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="这是一篇译文，在 Google 上搜索 JNI 相关的文章的时候，输入关键词 JNI tutorial，第一篇文章就是准备翻译的文章了。看了下目录，感觉还是挺不错的。于是乎决定选择这篇文章作为入门。顺便在翻译的同时写一些自己的见解。当然翻译并不是逐字逐句翻译的，会按照自己的理解组织语句。就把这篇作为 JNI 的入门文章吧。原文链接：https:&#x2F;&#x2F;www3.ntu.edu.sg&#x2F;home&#x2F;ehch">
<meta property="og:type" content="article">
<meta property="og:title" content="JNI tutorial Ⅰ">
<meta property="og:url" content="https://ffyzz.github.io/2020/01/07/JNI-tutorial-%E2%85%A0/index.html">
<meta property="og:site_name" content="Journey">
<meta property="og:description" content="这是一篇译文，在 Google 上搜索 JNI 相关的文章的时候，输入关键词 JNI tutorial，第一篇文章就是准备翻译的文章了。看了下目录，感觉还是挺不错的。于是乎决定选择这篇文章作为入门。顺便在翻译的同时写一些自己的见解。当然翻译并不是逐字逐句翻译的，会按照自己的理解组织语句。就把这篇作为 JNI 的入门文章吧。原文链接：https:&#x2F;&#x2F;www3.ntu.edu.sg&#x2F;home&#x2F;ehch">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-01-07T08:47:21.000Z">
<meta property="article:modified_time" content="2020-08-05T11:17:40.925Z">
<meta property="article:author" content="FFYzz">
<meta property="article:tag" content="JDK">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ffyzz.github.io/2020/01/07/JNI-tutorial-%E2%85%A0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>JNI tutorial Ⅰ | Journey</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Journey</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ffyzz.github.io/2020/01/07/JNI-tutorial-%E2%85%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="FFYzz">
      <meta itemprop="description" content="在自我鄙视中一步一步往上爬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Journey">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JNI tutorial Ⅰ
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-07 16:47:21" itemprop="dateCreated datePublished" datetime="2020-01-07T16:47:21+08:00">2020-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-05 19:17:40" itemprop="dateModified" datetime="2020-08-05T19:17:40+08:00">2020-08-05</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2020/01/07/JNI-tutorial-%E2%85%A0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/07/JNI-tutorial-Ⅰ/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>这是一篇译文，在 Google 上搜索 JNI 相关的文章的时候，输入关键词 JNI tutorial，第一篇文章就是准备翻译的文章了。看了下目录，感觉还是挺不错的。于是乎决定选择这篇文章作为入门。顺便在翻译的同时写一些自己的见解。当然翻译并不是逐字逐句翻译的，会按照自己的理解组织语句。就把这篇作为 JNI 的入门文章吧。原文链接：<a target="_blank" rel="noopener" href="https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html">https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html</a> 。</p>
<a id="more"></a>

<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>有些时候，在使用Java语言时，受限于无法<strong>管理内存</strong>以及<strong>性能</strong>，需要使用到 native 代码(也即非 Java 代码，包括 C/C++ 等一些编程语言)。Java 语言可以通过 Java Native Interface(JNI) 来使用 native 代码。</p>
<p>JNI在使用上是比较困难的，因为涉及到了两种编程语言和运行环境。</p>
<p>阅读此教程之前希望熟悉以下内容：</p>
<ol>
<li>Java</li>
<li>C/C++ 以及 GCC 编译器</li>
<li>Windows 系统上 Cygwin 或 MinGW 的使用</li>
</ol>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><h3 id="JNI-与-C-语言"><a href="#JNI-与-C-语言" class="headerlink" title="JNI 与 C 语言"></a>JNI 与 C 语言</h3><p><strong>step1 :</strong> 编写一个使用 C 语言实现的 Java 类 HelloJNI.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloJNI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态代码块</span></span><br><span class="line"><span class="comment">     * 用于加载 libhello.so(Unix系统下)</span></span><br><span class="line"><span class="comment">     * hello.dll(Windows系统下)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明一个 native 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用 native 方法</span></span><br><span class="line">        <span class="keyword">new</span> HelloJNI().sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>静态代码块在 JVM 加载类的时候会调用加载 native 库 “hello” (该 native 库中包含一个 native 方法 sayHello())。在 Windows 系统下，native 库关联 hello.dll 文件；在类 Unix 系统下关联 libhello.so 文件。native 库文件要被放在 Java 的库路径(Java’s library path)下。可以通过设置 JVM 参数 <strong>-Djava.library.path=/path/to/lib</strong> 来指定库路径。如果在库路径找不到 native 库，则会抛出 UnsatisfiedLinkError。</p>
<p>接着，我们声明了一个方法 sayHello() 作为一个 native 示例方法。通过关键词 <strong>native</strong> 可以表明该方法使用其他的编程语言实现的。一个 native 方法不包含方法体。同时，sayHello() 方法应该能够在被加载的 native 库中找到。</p>
<p>main 方法中得到一个 HelloJNI 类的实例，并且调用了 native 方法 sayHello()。</p>
<p><strong>step2 :</strong> 编译 Java 程序 HelloJNI.java &amp; 生成 C/C++ Header 文件 HelloJNI.h</p>
<p>从 JDK8 版本开始，应该使用 “javac -h” 来编译 Java 程序以及生成 C/C++ header 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -h . HelloJNI.java</span><br></pre></td></tr></table></figure>

<p>“-h dir” 选项用于生成 C/C++ header 并放在指定的路径，上述命令中的 “.” 表示当前目录。</p>
<p>JDK8 版本之前，需要使用 “javac” 编译 Java 程序，然后使用 “javah” 工具来生成 C/C++ 头文件。不过 JDK10 版本及之后， “javah” 工具不再提供。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac HelloJNI.java</span><br><span class="line">javah HelloJNI</span><br></pre></td></tr></table></figure>

<p>HelloJNI.h 的内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class HelloJNI */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_HelloJNI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     HelloJNI</span></span><br><span class="line"><span class="comment"> * Method:    sayHello</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_HelloJNI_sayHello</span><br><span class="line">  (JNIEnv *, jobject);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>头文件中声明了一个 C 函数 JNICALL Java_HelloJNI_sayHello(JNIEnv *, jobject);</p>
<p>C 函数名的命名转换为 Java_{package_and_classname}_{function_name}(JNI_arguments) 。包名中的点号用下划线替代。</p>
<p>参数如下：</p>
<ul>
<li>JNIEnv*：JNI 环境的引用，通过该引用可以访问 JNI 函数</li>
<li>jobject：”this” Java 对象的引用</li>
</ul>
<p>在 HelloJNI 这个例子中我们没有使用到这两个参数，但是后续会用到。暂时忽略 JNIEXPORT 和 JNICALL 这两个宏定义。</p>
<p>extern “C” 标识只能被 C++ 编译器识别出来。该标识通知 C++ 编译器这些函数是用 C 语言的函数命名协议而不是使用 C++ 的函数命名协议。C 和 C++ 使用不同的函数命名协议，因为 C++ 支持函数重载并且使用了 name mangling scheme[C++不是特别熟悉，所以不太清楚是啥] 去区分重载函数。</p>
<p><strong>step3 :</strong> 实现 C 程序 HelloJNI.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HelloJNI.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_HelloJNI_sayHello</span><span class="params">(JNIEnv * env, jobject thisObj)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将程序保存成 C 程序 “HelloJNI.c”</p>
<p>JNI header “jni.h” 由 JDK 提供，它位于 “&lt;JAVA_HOME&gt;\include” 下或者 “&lt;JAVA_HOME&gt;\include\win32” (Windows 平台) 或者 “&lt;JAVA_HOME&gt;\include\linux” (Ubuntu 系统)。其中 &lt;JAVA_HOME&gt; 是 JDK 安装的目录。</p>
<p><strong>step4 :</strong> 编译 C 程序 HelloJNI.c</p>
<p>针对不同的平台（Windows，MacOS，Linux）选择正确的编译器一般是最难的部分。[原文中提供了不同平台的编译方法，因为译者只有 Linux 环境和 MacOS 环境，所以就略过 Windows 平台了]</p>
<p><strong>MacOS :</strong> (64bit)</p>
<ul>
<li>设置环境变量 JAVA_HOME，指向安装 JDK 的目录(该目录需要包含子文件夹)。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk-13.0.1.jdk/Contents/Home</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$JAVA_HOME</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用 gcc 将 C 程序编译成动态共享链接库 libhello.dylib。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include&quot;</span> -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include/darwin&quot;</span> -dynamiclib -o libhello.dylib HelloJNI.c</span><br></pre></td></tr></table></figure>

<ul>
<li>运行 Java 程序</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. HelloJNI</span><br></pre></td></tr></table></figure>

<p><strong>step5 :</strong> 运行 Java 程序</p>
<p>在运行之前需要准确的指定 “libhello.so” 文件的 Java 库路径。使用 VM 选项 “Djava.library.path=/path/to/lib”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. HelloJNI</span><br></pre></td></tr></table></figure>

<p><strong>CentOS :</strong> (64bit)</p>
<ul>
<li>设置环境变量 JAVA_HOME，指向安装 JDK 的目录(该目录需要包含子文件夹)。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/your/jdk/path/to/bin/directory</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$JAVA_HOME</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用 gcc 将 C 程序编译成动态共享链接库 libhello.so。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -I<span class="string">&quot;/your/jdk/path/include&quot;</span> -I<span class="string">&quot;/your/jdk/path/include/linux&quot;</span> -shared -o libhello.so HelloJNI.c</span><br></pre></td></tr></table></figure>

<ul>
<li>运行 Java 程序</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. HelloJNI</span><br></pre></td></tr></table></figure>

<p><strong>step5 :</strong> 运行 Java 程序</p>
<p>在运行之前需要准确的指定 “libhello.so” 文件的 Java 库路径。使用 VM 选项 “Djava.library.path=/path/to/lib”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. HelloJNI</span><br></pre></td></tr></table></figure>

<p>其实这一步与上述的 3 是一致的，只是为了保证文章的完整性，所以也翻译过来了。</p>
<h3 id="JNI-与-C-语言-1"><a href="#JNI-与-C-语言-1" class="headerlink" title="JNI 与 C++ 语言"></a>JNI 与 C++ 语言</h3><p><strong>MacOS :</strong> (64bit)</p>
<ul>
<li>同样编写一个 C++ 程序</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save as &quot;HelloJNI.cpp&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;       // JNI header provided by JDK</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;    // C++ standard IO header</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HelloJNI.h&quot;</span>  <span class="comment">// Generated</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Implementation of the native method sayHello()</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_HelloJNI_sayHello</span><span class="params">(JNIEnv *env, jobject thisObj)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Hello World from C++!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 g++ 将 C++ 程序编译成动态链接库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include&quot;</span> -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include/darwin&quot;</span> -dynamiclib -o libhello.dylib HelloJNI.cpp</span><br></pre></td></tr></table></figure>

<ul>
<li>运行程序</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. HelloJNI</span><br></pre></td></tr></table></figure>

<p><strong>CentOS :</strong> (64bit)</p>
<ul>
<li><p>编写 C++ 程序</p>
</li>
<li><p>使用 g++ 将 C++ 程序编译成动态链接库</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -fPIC -I<span class="string">&quot;/your/jdk/path/include&quot;</span> -I<span class="string">&quot;/your/jdk/path/include/linux&quot;</span> -shared -o libhello.so HelloJNI.cpp</span><br></pre></td></tr></table></figure>

<ul>
<li>运行程序</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. HelloJNI</span><br></pre></td></tr></table></figure>


<h3 id="JNI-与-C-C-语言"><a href="#JNI-与-C-C-语言" class="headerlink" title="JNI 与 C/C++ 语言"></a>JNI 与 C/C++ 语言</h3><p><strong>MacOS : (64bit)</strong></p>
<p><strong>step1 :</strong> 编写一个 Java 程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloJNICpp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * native 方法声明</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Invoke native method</span></span><br><span class="line">        <span class="keyword">new</span> HelloJNICpp().sayHello();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>step2 :</strong> 编译 Java 程序 &amp; 生成 C/C++ 头文件 HelloJNICpp.h</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -h . HelloJNICpp.java</span><br></pre></td></tr></table></figure>

<p>生成的 HelloJNICpp.h 中的 native 函数为 JNIEXPORT void JNICALL Java_HelloJNICpp_sayHello(JNIEnv *, jobject);</p>
<p><strong>step3 :</strong> C/C++实现 - HelloJNICppImpl.h, HelloJNICppImpl.cpp, and HelloJNICpp.c</p>
<p>我们使用 C 程序的接口去实现。</p>
<p>C++ Header - “HelloJNICppImpl.h”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _HELLO_JNI_CPP_IMPL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _HELLO_JNI_CPP_IMPL_H</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span> <span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>C++ 实现 - “HelloJNICppImpl.cpp”</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HelloJNICppImpl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sayHello</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Hello World from C++!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>C 程序接口定义 - “HelloJNICpp.c”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HelloJNICpp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HelloJNICppImpl.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_HelloJNICpp_sayHello</span> <span class="params">(JNIEnv *env, jobject thisObj)</span> </span>&#123;</span><br><span class="line">    sayHello();  <span class="comment">// invoke C++ function</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>step4 :</strong> 编译动态链接库文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include&quot;</span> -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include/darwin&quot;</span> -dynamiclib -o libhello.dylib HelloJNICpp.c HelloJNICppImpl.cpp</span><br></pre></td></tr></table></figure>

<p><strong>step5 :</strong> 运行程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. HelloJNICpp</span><br></pre></td></tr></table></figure>

<p><strong>CentOS :</strong> (64bit)</p>
<p>代码文件都与 MacOS 环境下相同，区别只存在编译动态文件部分，所以只给出编译动态文件的命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -fPIC -I<span class="string">&quot;/your/jdk/path/include&quot;</span> -I<span class="string">&quot;/your/jdk/path/include/linux&quot;</span> -shared -o libhello.so HelloJNICpp.c HelloJNICppImpl.cpp</span><br></pre></td></tr></table></figure>

<h3 id="JNI-in-Package"><a href="#JNI-in-Package" class="headerlink" title="JNI in Package"></a>JNI in Package</h3><p>[该节就不翻译了，没什么营养，只是 Java 文件不在默认的包下，而是在某个 package 路径下]</p>
<h3 id="JNI-in-Module-JDK-9"><a href="#JNI-in-Module-JDK-9" class="headerlink" title="JNI in Module (JDK 9)"></a>JNI in Module (JDK 9)</h3><p>[TODO]</p>
<h3 id="JNI-in-Eclipse"><a href="#JNI-in-Eclipse" class="headerlink" title="JNI in Eclipse"></a>JNI in Eclipse</h3><p>[没人用 Eclipse 了吧….]</p>
<h3 id="JNI-in-NetBeans"><a href="#JNI-in-NetBeans" class="headerlink" title="JNI in NetBeans"></a>JNI in NetBeans</h3><p>[TODO]</p>
<h2 id="JNI-基础"><a href="#JNI-基础" class="headerlink" title="JNI 基础"></a>JNI 基础</h2><p>JNI 定义了以下 JNI 类型，以及与 Java 类型的对应关系如下：</p>
<ul>
<li>JNI 类型 :  jint, jbyte, jshort, jlong, jfloat, jdouble, jchar, jboolean 对应 Java Primitive 类型 : int, byte, short, long, float, double, char, boolean.</li>
<li>JNI 引用类型 jobject 对应 java.lang.Object, 同时有以下几个子类型：<ul>
<li>jclass 对应 java.lang.Class</li>
<li>jstring 对应 java.lang.String</li>
<li>jthrowable 对应 java.lang.Throwable.</li>
<li>jarray 对应 Java 数组, 有九种数组类型, 八种基本类型数组, 一种对象类型数组。 jintArray, jbyteArray, jshortArray, jlongArray, jfloatArray, jdoubleArray, jcharArray and jbooleanArray; 以及对象数组 jobjectArray.</li>
</ul>
</li>
</ul>
<p>native 函数接收以上列出的 JNI 类型并且返回的也是 JNI 类型。但是，native 函数运算的时候使用的是本地的类型(比如 C 语言使用的是 C 语言的数据类型)。因此，需要 JNI 类型与 native 类型能够相互转换。</p>
<p>native 程序：</p>
<ol>
<li>接收 JNI 类型的参数(从 Java 程序中传过来)。</li>
<li>对于引用的 JNI 类型，将参数转成或者拷贝成本地的 native 类型。比如，jstring 转成 C-string，jintArray 转成 C 语言的 int[]。基本 JNI 类型比如 jint 和 jdouble 不需要转换，可以直接使用。</li>
<li>以本地 native 类型执行操作。</li>
<li>创建一个 JNI 类型的返回值，并将结果拷贝到返回对象中。</li>
<li>返回。</li>
</ol>
<p>JNI 编程中最难的一部分就是 <strong>JNI 引用类型</strong> (jstring, jobject, jintArray, jobjectArray)与 本地 native 类型之间的转换。JNI Environment interface 中定义了很多方法用来进行转换。</p>
<p>JNI 是 C 接口，不是面向对象的，传递的时候不是传的对象。(值传递)</p>
<h2 id="在-Java-编程-和-Native-编程之间传递参数和结果"><a href="#在-Java-编程-和-Native-编程之间传递参数和结果" class="headerlink" title="在 Java 编程 和 Native 编程之间传递参数和结果"></a>在 Java 编程 和 Native 编程之间传递参数和结果</h2><h3 id="Primitive-类型数据传递"><a href="#Primitive-类型数据传递" class="headerlink" title="Primitive 类型数据传递"></a>Primitive 类型数据传递</h3><p>Java 的 primitive 类型的传递是直接可以使用的。Java 中的 基本类型 int, byte, short, long, float, double, char 以及 boolean 已经在 native 系统中定义了，可以直接对应 jint, jbyte, jshort, jlong, jfloat, jdouble, jchar 和 jboolean 类型。</p>
<p><strong>Java JNI 编程: TestJNIPrimitive.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIPrimitive</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// myjni.dll (Windows) or libmyjni.so (Unixes)</span></span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明一个 native 函数，接收两个 int 类型的参数，返回一个 double 类型的结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">double</span> <span class="title">average</span><span class="params">(<span class="keyword">int</span> n1, <span class="keyword">int</span> n2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test Driver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the average is &quot;</span> + <span class="keyword">new</span> TestJNIPrimitive().average(<span class="number">3</span>, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用一下命令将 Java 程序编译成 TestJNIPrimitive.class 文件，并生成 C/C++ Header 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -h . TestJNIPrimitive.java</span><br></pre></td></tr></table></figure>

<p><strong>C 实现 - TestJNIPrimitive.c</strong></p>
<p>头文件 TestJNIPrimitive.h 中包含 一个函数声明 Java_TestJNIPrimitive_average()。其中的参数与返回值:</p>
<ol>
<li>JNIEnv*, 用于访问 JNI 环境接口</li>
<li>jobject, 指向当前的 object</li>
<li>两个 jint 类型的参数</li>
<li>返回值 jdouble</li>
</ol>
<blockquote>
<p>JNIEXPORT jdouble JNICALL Java_TestJNIPrimitive_average(JNIEnv *, jobject, jint, jint);</p>
</blockquote>
<p>JNI 类型 jint 和 jdouble 分别对应 Java 的 int 和 double 类型。</p>
<p>“jni.h” 和 “jni_mh.h” 文件包含了 typedef 语句，里面定义了 native 类型的别名：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In &quot;jni_mh.h&quot; - machine header which is machine dependent</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> jint;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LP64</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> jlong;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> jlong;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">signed</span> <span class="keyword">char</span> jbyte;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// In &quot;jni.h&quot;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>   jboolean;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">short</span>  jchar;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">short</span>           jshort;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">float</span>           jfloat;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span>          jdouble;</span><br><span class="line"><span class="keyword">typedef</span> jint            jsize;</span><br></pre></td></tr></table></figure>

<p>TestJNIPrimitive.c 的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIPrimitive.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jdouble JNICALL Java_TestJNIPrimitive_average</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jint n1, jint n2) &#123;</span><br><span class="line">   jdouble result;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the numbers are %d and %d\n&quot;</span>, n1, n2);</span><br><span class="line">   result = ((jdouble)n1 + n2) / <span class="number">2.0</span>;</span><br><span class="line">   <span class="comment">// jint is mapped to int, jdouble is mapped to double</span></span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 C 程序编译成动态共享库文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mac 环境</span></span><br><span class="line">gcc -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include&quot;</span> -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include/darwin&quot;</span> -dynamiclib -o libmyjni.dylib TestJNIPrimitive.c</span><br><span class="line"><span class="comment"># CentOS 环境</span></span><br><span class="line">gcc -fPIC -I<span class="string">&quot;/your/jdk/path/include&quot;</span> -I<span class="string">&quot;/your/jdk/path/include/linux&quot;</span> -shared -o libmyjni.so TestJNIPrimitive.c</span><br></pre></td></tr></table></figure>

<p>运行程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. TestJNIPrimitive</span><br></pre></td></tr></table></figure>

<p><strong>C++ 实现 - TestJNIPrimitive.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIPrimitive.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jdouble JNICALL Java_TestJNIPrimitive_average</span><br><span class="line">          (JNIEnv *env, jobject obj, jint n1, jint n2) &#123;</span><br><span class="line">   jdouble result;</span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;In C++, the numbers are &quot;</span> &lt;&lt; n1 &lt;&lt; <span class="string">&quot; and &quot;</span> &lt;&lt; n2 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">   result = ((jdouble)n1 + n2) / <span class="number">2.0</span>;</span><br><span class="line">   <span class="comment">// jint is mapped to int, jdouble is mapped to double</span></span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 C++ 程序编译成动态共享库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mac 环境</span></span><br><span class="line">g++ -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include&quot;</span> -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include/darwin&quot;</span> -dynamiclib -o libmyjni.dylib TestJNIPrimitive.cpp</span><br><span class="line"><span class="comment"># CentOS 环境</span></span><br><span class="line">g++ -fPIC -I<span class="string">&quot;/your/jdk/path/include&quot;</span> -I<span class="string">&quot;/your/jdk/path/include/linux&quot;</span> -shared -o libmyjni.so TestJNIPrimitive.cpp</span><br></pre></td></tr></table></figure>

<p>运行程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. TestJNIPrimitive</span><br></pre></td></tr></table></figure>

<h3 id="String-类型数据传递"><a href="#String-类型数据传递" class="headerlink" title="String 类型数据传递"></a>String 类型数据传递</h3><p><strong>Java JNI 程序 : TestJNIString.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIString</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Native 方法接收一个 String 类型的参数，返回一个 String 类型的结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> String <span class="title">sayHello</span><span class="params">(String msg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        String result = <span class="keyword">new</span> TestJNIString().sayHello(<span class="string">&quot;Hello from Java&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the returned string is: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JNI 程序声明了一个 native 方法 sayHello()，接收一个 Java String 类型的参数，返回一个 Java String 类型的结果。</p>
<p>编译 Java 程序并生成 C/C++ 头文件 “TestJNIString.h”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class TestJNIString */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_TestJNIString</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_TestJNIString</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     TestJNIString</span></span><br><span class="line"><span class="comment"> * Method:    sayHello</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_TestJNIString_sayHello</span><span class="params">(JNIEnv *, jobject, jstring)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>C 实现 - TestJNIString.c</strong></p>
<p>头文件 TestJNIString.h 包含以下的函数声明</p>
<blockquote>
<p>JNIEXPORT jstring JNICALL Java_TestJNIString_sayHello(JNIEnv *, jobject, jstring);</p>
</blockquote>
<p>JNI 定义了一个 jstring 类型用于对应 Java 的 String 类型。最后的参数 jstring 是 Java 类型 String 传入 C 程序的参数。返回值的类型也是 jstring。</p>
<p>string 类型的传递比 primitive 类型的参数传递要复杂，因为 String 在 Java 中是 reference 类型，但是在 C 语言中 C-string 是一个空终止(NULL-terminated) char 数组。需要在两者之间进行转换。</p>
<p>JNI 环境提供了以下函数用于转换。以下函数可以通过 JNIEnv* 访问。</p>
<ul>
<li>jstring -&gt; C-string(char <em>) : const char</em> GetStringUTFChars(JNIEnv*, jstring, jboolean*)</li>
<li>C-string(char <em>) -&gt; jstring : jstring NewStringUTF(JNIEnv</em>, char*)</li>
</ul>
<p>C 语言中实现 TestJNIString.c </p>
<ol>
<li>通过 GetStringUTFChars() 函数将接收的 JNI jstring 类型转换成 C-string(char *) 类型。</li>
<li>执行预先设定的逻辑。</li>
<li>通过 NewStringUTF() 函数将 C-string(char *) 转换成 JNI 的 jstring 类型，最后返回 jstring 类型的值。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIString.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_TestJNIString_sayHello</span><span class="params">(JNIEnv *env, jobject thisObj, jstring inJNIStr)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Step 1: Convert the JNI String (jstring) into C-String (char*)</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *inCStr = (*env)-&gt;GetStringUTFChars(env, inJNIStr, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == inCStr) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Step 2: Perform its intended operations</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the received string is: %s\n&quot;</span>, inCStr);</span><br><span class="line">   (*env)-&gt;ReleaseStringUTFChars(env, inJNIStr, inCStr);  <span class="comment">// release resources</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Prompt user for a C-string</span></span><br><span class="line">   <span class="keyword">char</span> outCStr[<span class="number">128</span>];</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Enter a String: &quot;</span>);</span><br><span class="line">   <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, outCStr);    <span class="comment">// not more than 127 characters</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Step 3: Convert the C-string (char*) into JNI String (jstring) and return</span></span><br><span class="line">   <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, outCStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 C 程序编译动态共享库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include&quot;</span> -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include/darwin&quot;</span> -dynamiclib -o libmyjni.dylib TestJNIString.c</span><br></pre></td></tr></table></figure>

<p>运行 Java 程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=. TestJNIString</span><br></pre></td></tr></table></figure>

<p><strong>JNI Native String 函数</strong></p>
<p>JNI 支持 Unicode 和 UTF-8 编码 string 的转换。UTF-8 string 像空终止 C-strings(char 数组)，可以用于 C/C++ 程序中。</p>
<p>JNI string 函数包含以下:</p>
<blockquote>
<p>// UTF-8 String (encoded to 1-3 byte, backward compatible with 7-bit ASCII)<br>// Can be mapped to null-terminated char-array C-string<br>const char * GetStringUTFChars(JNIEnv *env, jstring string, jboolean *isCopy);<br>   // Returns a pointer to an array of bytes representing the string in modified UTF-8 encoding.<br>void ReleaseStringUTFChars(JNIEnv *env, jstring string, const char *utf);<br>   // Informs the VM that the native code no longer needs access to utf.<br>jstring NewStringUTF(JNIEnv *env, const char *bytes);<br>   // Constructs a new java.lang.String object from an array of characters in modified UTF-8 encoding.<br>jsize GetStringUTFLength(JNIEnv *env, jstring string);<br>   // Returns the length in bytes of the modified UTF-8 representation of a string.<br>void GetStringUTFRegion(JNIEnv *env, jstring str, jsize start, jsize length, char *buf);<br>   // Translates len number of Unicode characters beginning at offset start into modified UTF-8 encoding<br>   // and place the result in the given buffer buf.</p>
<p>// Unicode Strings (16-bit character)<br>const jchar * GetStringChars(JNIEnv *env, jstring string, jboolean *isCopy);<br>   // Returns a pointer to the array of Unicode characters<br>void ReleaseStringChars(JNIEnv *env, jstring string, const jchar *chars);<br>   // Informs the VM that the native code no longer needs access to chars.<br>jstring NewString(JNIEnv *env, const jchar *unicodeChars, jsize length);<br>   // Constructs a new java.lang.String object from an array of Unicode characters.<br>jsize GetStringLength(JNIEnv *env, jstring string);<br>   // Returns the length (the count of Unicode characters) of a Java string.<br>void GetStringRegion(JNIEnv *env, jstring str, jsize start, jsize length, jchar *buf);<br>   // Copies len number of Unicode characters beginning at offset start to the given buffer buf</p>
</blockquote>
<p><strong>UTF-8 strings 以及 C-strings</strong></p>
<p>GetStringUTFChars() 函数可以通过一个 jstring 来创建一个新的 C-string(char *)。如果不能成功分配内存，该函数会返回 NULL。该函数可以用于检查传入的 jstring 是否为 NULL。</p>
<p>第三个参数 <strong>isCopy</strong> 是一个 输入/输出 参数。如果返回的 string 是原始的 java.lang.String 实例的拷贝，则设为 JNI_TRUE。如果返回的 string 是原始 String 实例的直接指针，则设为 JNI_FALSE，在这种情况下， Native 代码不应该返回 string 的内容。如果可能的话，JNI运行环境会尝试返回一个直接指针，如果不行的话会返回一个 copy。然而，一般很少修改底层的 string，经常传入一个 NULL 的指针。</p>
<p>每当不需要使用 GetStringUTFChars() 函数的返回值 string，就调用 ReleaseStringUTFChars() 函数，该函数可以释放内存和引用。</p>
<p>NewStringUTF() 可以使用给定的 C-string 创建一个 JNI string。</p>
<p>JDK1.2 引入了 GetStringUTFRegion() 函数。可以将 jstring 中的值拷贝到一个预分配了内存的 C 语言 char 数组。该函数可以取代 GetStringUTFChars()。GetStringUTFRegion()<br>函数中不需要 isCopy 参数。</p>
<p>JDK1.2 同样引入了 Get/ReleaseStringCritical() 函数。与 GetStringUTFChars() 函数类似，该函数会尝试返回一个直接指针，否则返回一个拷贝。 native 函数在调用 GetStringCritical() 和 ReleaseStringCritical() 中间不应该阻塞 IO 或者其他。</p>
<p>更多的细节可以参考 Java Native Interface Specification Reference: <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/13/docs/specs/jni/index.html">https://docs.oracle.com/en/java/javase/13/docs/specs/jni/index.html</a></p>
<p><strong>Unicode String</strong></p>
<p>存储 Unicode 字符使用的是 jchar* 而不是 char*。</p>
<p><strong>C++ 实现 - TestJNIString.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIString.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_TestJNIString_sayHello</span><span class="params">(JNIEnv *env, jobject thisObj, jstring inJNIStr)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Step 1: Convert the JNI String (jstring) into C-String (char*)</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *inCStr = env-&gt;GetStringUTFChars(inJNIStr, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == inCStr) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Step 2: Perform its intended operations</span></span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;In C++, the received string is: &quot;</span> &lt;&lt; inCStr &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">   env-&gt;ReleaseStringUTFChars(inJNIStr, inCStr);  <span class="comment">// release resources</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Prompt user for a C++ string</span></span><br><span class="line">   <span class="built_in">string</span> outCppStr;</span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Enter a String: &quot;</span>;</span><br><span class="line">   <span class="built_in">cin</span> &gt;&gt; outCppStr;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Step 3: Convert the C++ string to C-string, then to JNI String (jstring) and return</span></span><br><span class="line">   <span class="keyword">return</span> env-&gt;NewStringUTF(outCppStr.c_str());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 g++ 编译 C++ 程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include&quot;</span> -I<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/include/darwin&quot;</span> -dynamiclib -o libmyjni.dylib TestJNIString.cpp</span><br></pre></td></tr></table></figure>

<p>C++ native string 函数的语法与 C 的语法不通。在 C++ 中，使用 “env-&gt;” 而不是 “(env*)-&gt;”。此外，在 C++ 函数中不需要使用 JNIEnv* 参数。</p>
<p>同样， C++ 支持 string 类</p>
<p>[TODO] C++ string 类是直接支持转换的吗？</p>
<h3 id="Array-of-Primitives-传递"><a href="#Array-of-Primitives-传递" class="headerlink" title="Array of Primitives 传递"></a>Array of Primitives 传递</h3><p><strong>JNI 程序 - TestJNIPrimitiveArray.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIPrimitiveArray</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Declare a native method sumAndAverage() that receives an int[] and</span></span><br><span class="line">    <span class="comment">//  return a double[2] array with [0] as sum and [1] as average</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">double</span>[] sumAndAverage(<span class="keyword">int</span>[] numbers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test Driver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] numbers = &#123;<span class="number">22</span>, <span class="number">33</span>, <span class="number">33</span>&#125;;</span><br><span class="line">        <span class="keyword">double</span>[] results = <span class="keyword">new</span> TestJNIPrimitiveArray().sumAndAverage(numbers);</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the sum is &quot;</span> + results[<span class="number">0</span>]);</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the average is &quot;</span> + results[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>C 实现 - TestJNIPrimitiveArray.c</strong></p>
<p>TestJNIPrimitiveArray.h 头文件中包含以下函数声明：</p>
<blockquote>
<p>JNIEXPORT jdoubleArray JNICALL Java_TestJNIPrimitiveArray_sumAndAverage(JNIEnv *, jobject, jintArray);</p>
</blockquote>
<p>在 Java 中， Array 是引用类型。 有 9 种 Java 类型的数组，一类是 primitives 类型的数组，另一类是 java.lang.object 类型的数组。 JNI 为每一个 Java 基本类型定义了数组类型 : jintArray, jbyteArray, jshortArray, jlongArray, jfloatArray, jdoubleArray, jcharArray, jbooleanArray。同时定义了 jobjectArray 类型用于对应 Java 中的 Object 类型。</p>
<p>同样，需要在 JNI Array 类型与 Native Array 类型之间进行转换。比如 jintArray 与 C 语言的 jint[] 类型的转换，jdoubleArray 与 C 语言的 jdouble[] 类型的转换。JNI 环境提供了一系列转换的函数。</p>
<ol>
<li>jintArray -&gt; jint[], jint* GetIntArrayElements(JNIEnv *env, jintArray a, jboolean *iscopy).</li>
<li>jint[] -&gt; jintArray, 首先调用 jintArray NewIntArray(JNIEnv *env, jsize len) 进行分配内存。再使用 void SetIntArrayRegion(JNIEnv *env, jintArray a, jsize start, jsize len, const jint *buf) 进行数据的拷贝。</li>
</ol>
<p>对于每种基本类型都有上述的转换函数。</p>
<p>native 程序的编写：</p>
<ol>
<li>接收 JNI Array 输入，转换成 C 语言的 native 数组。</li>
<li>执行相关逻辑。</li>
<li>将 C 语言的 native 数组 转成 JNI array 类型的数组，返回 JNI 类型的数组。</li>
</ol>
<p><strong>C 实现 - TestJNIPrimitiveArray.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIPrimitiveArray.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jdoubleArray JNICALL Java_TestJNIPrimitiveArray_sumAndAverage</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jintArray inJNIArray) &#123;</span><br><span class="line">   <span class="comment">// Step 1: Convert the incoming JNI jintarray to C&#x27;s jint[]</span></span><br><span class="line">   jint *inCArray = (*env)-&gt;GetIntArrayElements(env, inJNIArray, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == inCArray) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   jsize length = (*env)-&gt;GetArrayLength(env, inJNIArray);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Step 2: Perform its intended operations</span></span><br><span class="line">   jint sum = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">      sum += inCArray[i];</span><br><span class="line">   &#125;</span><br><span class="line">   jdouble average = (jdouble)sum / length;</span><br><span class="line">   (*env)-&gt;ReleaseIntArrayElements(env, inJNIArray, inCArray, <span class="number">0</span>); <span class="comment">// release resources</span></span><br><span class="line"></span><br><span class="line">   jdouble outCArray[] = &#123;sum, average&#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Step 3: Convert the C&#x27;s Native jdouble[] to JNI jdoublearray, and return</span></span><br><span class="line">   jdoubleArray outJNIArray = (*env)-&gt;NewDoubleArray(env, <span class="number">2</span>);  <span class="comment">// allocate</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == outJNIArray) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   (*env)-&gt;SetDoubleArrayRegion(env, outJNIArray, <span class="number">0</span> , <span class="number">2</span>, outCArray);  <span class="comment">// copy</span></span><br><span class="line">   <span class="keyword">return</span> outJNIArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JNI Primitive Array 函数</strong></p>
<p>JNI Primitive Array(jintArray, jbyteArray, jshortArray, jlongArray, jfloatArray, jdoubleArray, jcharArray and jbooleanArray) 函数有以下：</p>
<blockquote>
<p>// ArrayType: jintArray, jbyteArray, jshortArray, jlongArray, jfloatArray, jdoubleArray, jcharArray, jbooleanArray<br>// PrimitiveType: int, byte, short, long, float, double, char, boolean<br>// NativeType: jint, jbyte, jshort, jlong, jfloat, jdouble, jchar, jboolean<br>NativeType * Get<PrimitiveType>ArrayElements(JNIEnv *env, ArrayType array, jboolean *isCopy);<br>void Release<PrimitiveType>ArrayElements(JNIEnv *env, ArrayType array, NativeType *elems, jint mode);<br>void Get<PrimitiveType>ArrayRegion(JNIEnv *env, ArrayType array, jsize start, jsize length, NativeType *buffer);<br>void Set<PrimitiveType>ArrayRegion(JNIEnv *env, ArrayType array, jsize start, jsize length, const NativeType *buffer);<br>ArrayType New<PrimitiveType>Array(JNIEnv *env, jsize length);<br>void * GetPrimitiveArrayCritical(JNIEnv *env, jarray array, jboolean *isCopy);<br>void ReleasePrimitiveArrayCritical(JNIEnv *env, jarray array, void *carray, jint mode);</p>
</blockquote>
<p>GET|Release<PrimitiveType>ArrayElements() 函数用于从给定的 jxxxArray 创建一个新的 C 语言的 native array。GET|Set<PrimitiveType>ArrayRegion() 函数用于将一个 jxxxArray 数组上的内容拷贝到一个预分配的 C 语言的 native 数组中。New<PrimitiveType>Array() 函数分配一个新的给定大小的 jxxxArray。Set<PrimitiveType>ArrayRegion() 可以从 jxxx[] 中取出值并填充到 jxxxArray 中。 Get|ReleasePrimitiveArrayCritical() 函数调用中间不允许其他的阻塞调用。</p>
<h2 id="访问对象的变量以及回调方法"><a href="#访问对象的变量以及回调方法" class="headerlink" title="访问对象的变量以及回调方法"></a>访问对象的变量以及回调方法</h2><h3 id="访问对象的实例变量"><a href="#访问对象的实例变量" class="headerlink" title="访问对象的实例变量"></a>访问对象的实例变量</h3><p><strong>JNI 程序 - TestJNIInstanceVariable.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIInstanceVariable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实例变量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">88</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实例变量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message = <span class="string">&quot;Hello from Java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Declare a native method that modifies the instance variables</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">modifyInstanceVariable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test Driver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        TestJNIInstanceVariable test = <span class="keyword">new</span> TestJNIInstanceVariable();</span><br><span class="line">        test.modifyInstanceVariable();</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, int is &quot;</span> + test.number);</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, String is &quot;</span> + test.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类中包含两个私有的实例变量：一个 primitive int 类型和 Reference String 类型。同样声明了一个 native 方法，用于修改实例变量的值。 </p>
<p><strong>C 实现 - TestJNIInstanceVariable.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIInstanceVariable.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_TestJNIInstanceVariable_modifyInstanceVariable</span><br><span class="line">          (JNIEnv *env, jobject thisObj) &#123;</span><br><span class="line">   <span class="comment">// Get a reference to this object&#x27;s class</span></span><br><span class="line">   jclass thisClass = (*env)-&gt;GetObjectClass(env, thisObj);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// int</span></span><br><span class="line">   <span class="comment">// Get the Field ID of the instance variables &quot;number&quot;</span></span><br><span class="line">   jfieldID fidNumber = (*env)-&gt;GetFieldID(env, thisClass, <span class="string">&quot;number&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidNumber) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Get the int given the Field ID</span></span><br><span class="line">   jint number = (*env)-&gt;GetIntField(env, thisObj, fidNumber);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the int is %d\n&quot;</span>, number);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Change the variable</span></span><br><span class="line">   number = <span class="number">99</span>;</span><br><span class="line">   (*env)-&gt;SetIntField(env, thisObj, fidNumber, number);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Get the Field ID of the instance variables &quot;message&quot;</span></span><br><span class="line">   jfieldID fidMessage = (*env)-&gt;GetFieldID(env, thisClass, <span class="string">&quot;message&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidMessage) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// String</span></span><br><span class="line">   <span class="comment">// Get the object given the Field ID</span></span><br><span class="line">   jstring message = (*env)-&gt;GetObjectField(env, thisObj, fidMessage);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Create a C-string with the JNI String</span></span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *cStr = (*env)-&gt;GetStringUTFChars(env, message, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == cStr) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the string is %s\n&quot;</span>, cStr);</span><br><span class="line">   (*env)-&gt;ReleaseStringUTFChars(env, message, cStr);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Create a new C-string and assign to the JNI string</span></span><br><span class="line">   message = (*env)-&gt;NewStringUTF(env, <span class="string">&quot;Hello from C&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == message) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// modify the instance variables</span></span><br><span class="line">   (*env)-&gt;SetObjectField(env, thisObj, fidMessage, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问一个对象的实例变量的步骤：</p>
<ol>
<li>通过 GetObjectClass() 方法获取该对象的引用。</li>
<li>通过 GetFieldID() 获取实例变量的 Field ID。需要提供实例变量的名称和 Field 的描述符(或者是签名)。对于一个 Java 类，Field 描述符的形式为 “L<fully-qualified-name>“，将点替换为斜杠。比如 String 的描述符为 “Ljava/lang/String;”。对于 Primitive 类型而言， “I” 表示 int, “B” 代表 byte, “S” 代表 short, “J” 代表 long, “F” 代表 float, “C” 代表 char, “Z” 代表 boolean。对于数组而言，包含一个前缀 “[“，比如 “[Ljava/lang/Object” 表示任意的 Object 对象。 “[I” 表示 int[] 。</li>
<li>基于 Field ID，通过 GetObjectField() 或者 Get<primitive-type>Field() 函数可以获取到实例变量。 </li>
<li>为了更新实例变量，可以使用 SetObjectField() 或者 Set<primitive-type>Field() 函数，传入 Field ID。</li>
</ol>
<p>访问实例变量的 JNI 函数有：</p>
<blockquote>
<p>jclass GetObjectClass(JNIEnv *env, jobject obj);<br>   // Returns the class of an object.</p>
<p>jfieldID GetFieldID(JNIEnv *env, jclass cls, const char *name, const char *sig);<br>  // Returns the field ID for an instance variable of a class.</p>
<p>NativeType Get<type>Field(JNIEnv *env, jobject obj, jfieldID fieldID);</p>
<p>void Set<type>Field(JNIEnv *env, jobject obj, jfieldID fieldID, NativeType value);<br>  // Get/Set the value of an instance variable of an object<br>  // <type> includes each of the eight primitive types plus Object.</p>
</blockquote>
<h3 id="访问类的静态变量"><a href="#访问类的静态变量" class="headerlink" title="访问类的静态变量"></a>访问类的静态变量</h3><p>访问静态变量与访问实例变量类似，除了使用的函数不同之外，访问静态变量使用这些函数：GetStaticFieldID(), Get|SetStaticObjectField(), Get|SetStatic<Primitive-type>Field()。</p>
<p><strong>JNI 程序 - TestJNIStaticVariable.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIStaticVariable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态变量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> number = <span class="number">55.66</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明一个 native 方法用于修改静态变量的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">modifyStaticVariable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test Driver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        TestJNIStaticVariable test = <span class="keyword">new</span> TestJNIStaticVariable();</span><br><span class="line">        test.modifyStaticVariable();</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the double is &quot;</span> + number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>C 实现 - TestJNIStaticVariable.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIStaticVariable.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_TestJNIStaticVariable_modifyStaticVariable</span><br><span class="line">          (JNIEnv *env, jobject thisObj) &#123;</span><br><span class="line">   <span class="comment">// Get a reference to this object&#x27;s class</span></span><br><span class="line">   jclass cls = (*env)-&gt;GetObjectClass(env, thisObj);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Read the int static variable and modify its value</span></span><br><span class="line">   jfieldID fidNumber = (*env)-&gt;GetStaticFieldID(env, cls, <span class="string">&quot;number&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == fidNumber) <span class="keyword">return</span>;</span><br><span class="line">   jdouble number = (*env)-&gt;GetStaticDoubleField(env, cls, fidNumber);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the double is %f\n&quot;</span>, number);</span><br><span class="line">   number = <span class="number">77.88</span>;</span><br><span class="line">   (*env)-&gt;SetStaticDoubleField(env, cls, fidNumber, number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 静态变量的 JNI 函数 : </p>
<blockquote>
<p>jfieldID GetStaticFieldID(JNIEnv *env, jclass cls, const char *name, const char *sig);<br>  // Returns the field ID for a static variable of a class.</p>
<p>NativeType GetStatic<type>Field(JNIEnv *env, jclass clazz, jfieldID fieldID);</p>
<p>void SetStatic<type>Field(JNIEnv *env, jclass clazz, jfieldID fieldID, NativeType value);<br>  // Get/Set the value of a static variable of a class.<br>  // <type> includes each of the eight primitive types plus Object.</p>
</blockquote>
<h3 id="回调实例方法和静态方法"><a href="#回调实例方法和静态方法" class="headerlink" title="回调实例方法和静态方法"></a>回调实例方法和静态方法</h3><p>可以从 native 代码中回调实例方法和静态方法</p>
<p><strong>JNI 程序 - TestJNICallBackMethod.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNICallBackMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明一个 native 方法用于回调下面的 Java 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeMethod</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 nativa 代码中被调用的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 nativa 代码中被调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callback</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java with &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 nativa 代码中被调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">callbackAverage</span><span class="params">(<span class="keyword">int</span> n1, <span class="keyword">int</span> n2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">double</span>) n1 + n2) / <span class="number">2.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 native 代码中被调用的 静态方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">callbackStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;From static Java method&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test Driver</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> TestJNICallBackMethod().nativeMethod();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类中声明了一个 native 方法，并且在 main 方法中调用了该方法。nativa 方法实现了调用 Java 中的 实例方法和静态方法。</p>
<p><strong>C 实现 - TestJNICallBackMethod.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNICallBackMethod.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_TestJNICallBackMethod_nativeMethod</span><br><span class="line">          (JNIEnv *env, jobject thisObj) &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Get a class reference for this object</span></span><br><span class="line">   jclass thisClass = (*env)-&gt;GetObjectClass(env, thisObj);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Get the Method ID for method &quot;callback&quot;, which takes no arg and return void</span></span><br><span class="line">   jmethodID midCallBack = (*env)-&gt;GetMethodID(env, thisClass, <span class="string">&quot;callback&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBack) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, call back Java&#x27;s callback()\n&quot;</span>);</span><br><span class="line">   <span class="comment">// Call back the method (which returns void), baed on the Method ID</span></span><br><span class="line">   (*env)-&gt;CallVoidMethod(env, thisObj, midCallBack);</span><br><span class="line"></span><br><span class="line">   jmethodID midCallBackStr = (*env)-&gt;GetMethodID(env, thisClass,</span><br><span class="line">                               <span class="string">&quot;callback&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBackStr) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, call back Java&#x27;s called(String)\n&quot;</span>);</span><br><span class="line">   jstring message = (*env)-&gt;NewStringUTF(env, <span class="string">&quot;Hello from C&quot;</span>);</span><br><span class="line">   (*env)-&gt;CallVoidMethod(env, thisObj, midCallBackStr, message);</span><br><span class="line"></span><br><span class="line">   jmethodID midCallBackAverage = (*env)-&gt;GetMethodID(env, thisClass,</span><br><span class="line">                                  <span class="string">&quot;callbackAverage&quot;</span>, <span class="string">&quot;(II)D&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBackAverage) <span class="keyword">return</span>;</span><br><span class="line">   jdouble average = (*env)-&gt;CallDoubleMethod(env, thisObj, midCallBackAverage, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the average is %f\n&quot;</span>, average);</span><br><span class="line"></span><br><span class="line">   jmethodID midCallBackStatic = (*env)-&gt;GetStaticMethodID(env, thisClass,</span><br><span class="line">                                 <span class="string">&quot;callbackStatic&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midCallBackStatic) <span class="keyword">return</span>;</span><br><span class="line">   jstring resultJNIStr = (*env)-&gt;CallStaticObjectMethod(env, thisClass, midCallBackStatic);</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *resultCStr = (*env)-&gt;GetStringUTFChars(env, resultJNIStr, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == resultCStr) <span class="keyword">return</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the returned string is %s\n&quot;</span>, resultCStr);</span><br><span class="line">   (*env)-&gt;ReleaseStringUTFChars(env, resultJNIStr, resultCStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 native 代码中调用实例方法的步骤：</p>
<ol>
<li>通过 GetObjectClass() 获得对象的引用。</li>
<li>根据类的引用，调用 GetMethodID() 获得 Method ID。需要提供方法的方法名和签名。方法签名的形式为 “(parameters)return-type”。通过 javap 工具可以列出方法的签名。</li>
<li>基于 Method ID，可以调用 Call<Primitive-type>Method() 或 CallVoidMethod() 或 CallObjectMethod() 函数。这些函数的返回值分别为 <Primitive-type>, void, Object。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; javap -s -p TestJNICallBackMethod</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  private void callback();</span><br><span class="line">    descriptor: ()V</span><br><span class="line"></span><br><span class="line">  private void callback(java.lang.String);</span><br><span class="line">    descriptor: (Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">  private double callbackAverage(int, int);</span><br><span class="line">    descriptor: (II)D</span><br><span class="line"></span><br><span class="line">  private static java.lang.String callbackStatic();</span><br><span class="line">    descriptor: ()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>要调用静态方法，使用 GetStaticMethodID(), CallStatic<Primitive-type>Method(), CallStaticVoidMethod() 或者 CallStaticObjectMethod() 函数。</p>
<p>调用实例方法和静态方法的 JNI 函数为 : </p>
<blockquote>
<p>jmethodID GetMethodID(JNIEnv *env, jclass cls, const char *name, const char *sig);<br>   // Returns the method ID for an instance method of a class or interface.</p>
<p>NativeType Call<type>Method(JNIEnv *env, jobject obj, jmethodID methodID, …);<br>NativeType Call<type>MethodA(JNIEnv *env, jobject obj, jmethodID methodID, const jvalue *args);<br>NativeType Call<type>MethodV(JNIEnv *env, jobject obj, jmethodID methodID, va_list args);<br>   // Invoke an instance method of the object.<br>   // The <type> includes each of the eight primitive and Object.</p>
<p>jmethodID GetStaticMethodID(JNIEnv *env, jclass cls, const char *name, const char *sig);<br>   // Returns the method ID for an instance method of a class or interface.</p>
<p>NativeType CallStatic<type>Method(JNIEnv *env, jclass clazz, jmethodID methodID, …);<br>NativeType CallStatic<type>MethodA(JNIEnv *env, jclass clazz, jmethodID methodID, const jvalue *args);<br>NativeType CallStatic<type>MethodV(JNIEnv *env, jclass clazz, jmethodID methodID, va_list args);<br>   // Invoke an instance method of the object.<br>   // The <type> includes each of the eight primitive and Object.</p>
</blockquote>
<h3 id="回调父类的实例方法"><a href="#回调父类的实例方法" class="headerlink" title="回调父类的实例方法"></a>回调父类的实例方法</h3><p>JNI 提供了一系列 CallNonvirtual<Type>Method() 方法，用于调用父类的实例方法。(调用在当前类的方法中通过 super.methodname() 调用的方法)调用步骤如下 : </p>
<ol>
<li>通过 GetMethodID() 获取 Method ID。</li>
<li>基于 Method ID，调用 CallNonvirtual<Type>Method() 方法。</li>
</ol>
<p>调用重写父类的实例方法的 JNI 函数 : </p>
<blockquote>
<p>NativeType CallNonvirtual<type>Method(JNIEnv *env, jobject obj, jclass cls, jmethodID methodID, …);<br>NativeType CallNonvirtual<type>MethodA(JNIEnv *env, jobject obj, jclass cls, jmethodID methodID, const jvalue *args);<br>NativeType CallNonvirtual<type>MethodV(JNIEnv *env, jobject obj, jclass cls, jmethodID methodID, va_list args);</p>
</blockquote>
<h2 id="创建对象和数组"><a href="#创建对象和数组" class="headerlink" title="创建对象和数组"></a>创建对象和数组</h2><p>可以在 native 代码中通过 NewObject() 和 newObjectArray() 函数创建 jobject 和 jobjectArray ，并把他们回传到 Java 程序中。</p>
<h3 id="在-Native-代码中调用构造函数创建新的-Java-对象"><a href="#在-Native-代码中调用构造函数创建新的-Java-对象" class="headerlink" title="在 Native 代码中调用构造函数创建新的 Java 对象"></a>在 Native 代码中调用构造函数创建新的 Java 对象</h3><p>回调构造函数和回调方法类似。首先，通过传入 “<init>“ 作为方法名 和 “V” 作为返回类型得到构造方法的 Method ID。然后使用 NewObject() 方法去调用构造器创建新的 Java 对象。</p>
<p><strong>JNI 程序 - TestJavaConstructor.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIConstructor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Native method that calls back the constructor and return the constructed object.</span></span><br><span class="line">    <span class="comment">// Return an Integer object with the given int.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> Integer <span class="title">getIntegerObject</span><span class="params">(<span class="keyword">int</span> number)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        TestJNIConstructor obj = <span class="keyword">new</span> TestJNIConstructor();</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the number is :&quot;</span> + obj.getIntegerObject(<span class="number">9999</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该类声明了一个 native 方法，基于给定的参数，该 native 方法应该创建并返回一个 Integer 对象。</p>
<p><strong>C 实现 - TestJavaConstructor.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIConstructor.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">JNIEXPORT jobject JNICALL Java_TestJNIConstructor_getIntegerObject</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jint number) &#123;</span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Integer</span></span><br><span class="line">   jclass cls = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Integer&quot;</span>);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Get the Method ID of the constructor which takes an int</span></span><br><span class="line">   jmethodID midInit = (*env)-&gt;GetMethodID(env, cls, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midInit) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   <span class="comment">// Call back constructor to allocate a new instance, with an int argument</span></span><br><span class="line">   jobject newObj = (*env)-&gt;NewObject(env, cls, midInit, number);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Try running the toString() on this newly create object</span></span><br><span class="line">   jmethodID midToString = (*env)-&gt;GetMethodID(env, cls, <span class="string">&quot;toString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midToString) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   jstring resultStr = (*env)-&gt;CallObjectMethod(env, newObj, midToString);</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *resultCStr = (*env)-&gt;GetStringUTFChars(env, resultStr, <span class="literal">NULL</span>);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C: the number is %s\n&quot;</span>, resultCStr);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//May need to call releaseStringUTFChars() before return</span></span><br><span class="line">   <span class="keyword">return</span> newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以创建对象的 JNI 函数：</p>
<blockquote>
<p>jclass FindClass(JNIEnv *env, const char *name);</p>
<p>jobject NewObject(JNIEnv *env, jclass cls, jmethodID methodID, …);<br>jobject NewObjectA(JNIEnv *env, jclass cls, jmethodID methodID, const jvalue *args);<br>jobject NewObjectV(JNIEnv *env, jclass cls, jmethodID methodID, va_list args);<br>   // Constructs a new Java object. The method ID indicates which constructor method to invoke</p>
<p>jobject AllocObject(JNIEnv *env, jclass cls);<br>  // Allocates a new Java object without invoking any of the constructors for the object. </p>
</blockquote>
<h3 id="对象数组"><a href="#对象数组" class="headerlink" title="对象数组"></a>对象数组</h3><p><strong>JNI 程序 - TestJNIObjectArray.java</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJNIObjectArray</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;myjni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Native method that receives an Integer[] and</span></span><br><span class="line">    <span class="comment">//  returns a Double[2] with [0] as sum and [1] as average</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> Double[] sumAndAverage(Integer[] numbers);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        Integer[] numbers = &#123;<span class="number">11</span>, <span class="number">22</span>, <span class="number">32</span>&#125;;  <span class="comment">// auto-box</span></span><br><span class="line">        Double[] results = <span class="keyword">new</span> TestJNIObjectArray().sumAndAverage(numbers);</span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the sum is &quot;</span> + results[<span class="number">0</span>]);  <span class="comment">// auto-unbox</span></span><br><span class="line">        System.out.println(<span class="string">&quot;In Java, the average is &quot;</span> + results[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类中声明了一个 native 方法，该方法输入一个 Integer 类型的数组，计算数组中元素的和以及平均值，返回 Double 类型的数组。</p>
<p><strong>C 实现 - TestJNIObjectArray.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIObjectArray.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jobjectArray JNICALL Java_TestJNIObjectArray_sumAndAverage</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jobjectArray inJNIArray) &#123;</span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Integer</span></span><br><span class="line">   jclass classInteger = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Integer&quot;</span>);</span><br><span class="line">   <span class="comment">// Use Integer.intValue() to retrieve the int</span></span><br><span class="line">   jmethodID midIntValue = (*env)-&gt;GetMethodID(env, classInteger, <span class="string">&quot;intValue&quot;</span>, <span class="string">&quot;()I&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midIntValue) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Get the value of each Integer object in the array</span></span><br><span class="line">   jsize length = (*env)-&gt;GetArrayLength(env, inJNIArray);</span><br><span class="line">   jint sum = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">      jobject objInteger = (*env)-&gt;GetObjectArrayElement(env, inJNIArray, i);</span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">NULL</span> == objInteger) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">      jint value = (*env)-&gt;CallIntMethod(env, objInteger, midIntValue);</span><br><span class="line">      sum += value;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">double</span> average = (<span class="keyword">double</span>)sum / length;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the sum is %d\n&quot;</span>, sum);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, the average is %f\n&quot;</span>, average);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Double</span></span><br><span class="line">   jclass classDouble = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Double&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allocate a jobjectArray of 2 java.lang.Double</span></span><br><span class="line">   jobjectArray outJNIArray = (*env)-&gt;NewObjectArray(env, <span class="number">2</span>, classDouble, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Construct 2 Double objects by calling the constructor</span></span><br><span class="line">   jmethodID midDoubleInit = (*env)-&gt;GetMethodID(env, classDouble, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(D)V&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midDoubleInit) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   jobject objSum = (*env)-&gt;NewObject(env, classDouble, midDoubleInit, (<span class="keyword">double</span>)sum);</span><br><span class="line">   jobject objAve = (*env)-&gt;NewObject(env, classDouble, midDoubleInit, average);</span><br><span class="line">   <span class="comment">// Set to the jobjectArray</span></span><br><span class="line">   (*env)-&gt;SetObjectArrayElement(env, outJNIArray, <span class="number">0</span>, objSum);</span><br><span class="line">   (*env)-&gt;SetObjectArrayElement(env, outJNIArray, <span class="number">1</span>, objAve);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> outJNIArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不像 Primitive 数组可以一起处理，对象数组需要使用 Get|SetObjectArrayElement() 函数一个一个进行处理。</p>
<p>创建和处理对象数组的 JNI 函数 : </p>
<blockquote>
<p>jobjectArray NewObjectArray(JNIEnv *env, jsize length, jclass elementClass, jobject initialElement);<br>   // Constructs a new array holding objects in class elementClass.<br>   // All elements are initially set to initialElement.</p>
<p>jobject GetObjectArrayElement(JNIEnv *env, jobjectArray array, jsize index);<br>   // Returns an element of an Object array.</p>
<p>void SetObjectArrayElement(JNIEnv *env, jobjectArray array, jsize index, jobject value);<br>   // Sets an element of an Object array.</p>
</blockquote>
<h2 id="本地和全局引用"><a href="#本地和全局引用" class="headerlink" title="本地和全局引用"></a>本地和全局引用</h2><p>对于引用的管理是编写高效的程序的关键。比如，我们在 native 代码中经常仅调用一次 FindClass(), GetMethodID(), GetFieldID() 函数去获取 jclass, jmethodID 以及 jfieldID。而不是重复多次调用。取到的值我们需要将其缓存起来后续要用的时候直接去缓存。</p>
<p>JNI 将对象引用分为两类，一类是 <strong>本地引用</strong>，另一类是 <strong>全局引用</strong>。</p>
<ol>
<li>本地引用是在 native 方法中创建的。随着方法的退出，内存也就释放了。本地引用的作用于仅限于 native 方法内。可以使用 JNI 函数 DeleteLocalRef() 准确的将一个本地引用失效。因此它该引用会在  GC 的时候被马上回收。对象被作为本地引用传递到 native 方法中。所有 JNI 函数返回的 Java 对象都是本地引用。</li>
<li>全局引用只能被程序员手动的准确的释放。可以通过 JNI 的 DeleteGlobalRef() 函数。也可以基于一个本地引用，通过 NewGlobalRef() 函数创建一个新的全局引用。</li>
</ol>
<p><strong>Example</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class TestJNIReference &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        System.loadLibrary(&quot;myjni&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * native 方法</span><br><span class="line">     *</span><br><span class="line">     * @param number</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private native Integer getIntegerObject(int number);</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * native 方法</span><br><span class="line">     *</span><br><span class="line">     * @param number</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private native Integer anotherGetIntegerObject(int number);</span><br><span class="line"></span><br><span class="line">    public static void main(String args[]) &#123;</span><br><span class="line">        TestJNIReference test &#x3D; new TestJNIReference();</span><br><span class="line">        System.out.println(test.getIntegerObject(1));</span><br><span class="line">        System.out.println(test.getIntegerObject(2));</span><br><span class="line">        System.out.println(test.anotherGetIntegerObject(11));</span><br><span class="line">        System.out.println(test.anotherGetIntegerObject(12));</span><br><span class="line">        System.out.println(test.getIntegerObject(3));</span><br><span class="line">        System.out.println(test.anotherGetIntegerObject(13));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述 JNI 程序中包含两个 native 方法。都创建并返回一个 Integer 类型的对象。<br>在 C 代码实现中，需要通过 FindClass() 获取到 java.lang.Integer 类引用。 随后需要找到 Integer 类的构造器的 Method ID，并且调用该构造函数。然而，我们会缓存 class reference 和 Method ID 以作后用。</p>
<p>下述的 C 程序不能正常运行??????????[那原文作者写这段代码是干啥??????后续再看看]</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TestJNIReference.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Global Reference to the Java class &quot;java.lang.Integer&quot;</span></span><br><span class="line"><span class="keyword">static</span> jclass classInteger;</span><br><span class="line"><span class="keyword">static</span> jmethodID midIntegerInit;</span><br><span class="line"> </span><br><span class="line"><span class="function">jobject <span class="title">getInteger</span><span class="params">(JNIEnv *env, jobject thisObj, jint number)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Get a class reference for java.lang.Integer if missing</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == classInteger) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Find java.lang.Integer\n&quot;</span>);</span><br><span class="line">      classInteger = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Integer&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == classInteger) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Get the Method ID of the Integer&#x27;s constructor if missing</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midIntegerInit) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Get Method ID for java.lang.Integer&#x27;s constructor\n&quot;</span>);</span><br><span class="line">      midIntegerInit = (*env)-&gt;GetMethodID(env, classInteger, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="literal">NULL</span> == midIntegerInit) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// Call back constructor to allocate a new instance, with an int argument</span></span><br><span class="line">   jobject newObj = (*env)-&gt;NewObject(env, classInteger, midIntegerInit, number);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;In C, constructed java.lang.Integer with number %d\n&quot;</span>, number);</span><br><span class="line">   <span class="keyword">return</span> newObj;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">JNIEXPORT jobject JNICALL Java_TestJNIReference_getIntegerObject</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jint number) &#123;</span><br><span class="line">   <span class="keyword">return</span> getInteger(env, thisObj, number);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">JNIEXPORT jobject JNICALL Java_TestJNIReference_anotherGetIntegerObject</span><br><span class="line">          (JNIEnv *env, jobject thisObj, jint number) &#123;</span><br><span class="line">   <span class="keyword">return</span> getInteger(env, thisObj, number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>在上述代码中，调用了 FindClass() 去寻找 java.lang.Integer 的类引用，并将其存到一个静态全局变量中。尽管如此，在下一次调用的时候，该引用不再有效了。这是因为 FindClass() 返回一个本地的引用，本地引用当方法退出后就失效了。</p>
<p>为了解决这个问题，我们需要根据 FindClass() 返回的本地引用创建一个全局引用。随后我们可以释放本地引用。修改后的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get a class reference for java.lang.Integer if missing</span></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == classInteger) &#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Find java.lang.Integer\n&quot;</span>);</span><br><span class="line">   <span class="comment">// FindClass returns a local reference</span></span><br><span class="line">   jclass classIntegerLocal = (*env)-&gt;FindClass(env, <span class="string">&quot;java/lang/Integer&quot;</span>);</span><br><span class="line">   <span class="comment">// Create a global reference from the local reference</span></span><br><span class="line">   classInteger = (*env)-&gt;NewGlobalRef(env, classIntegerLocal);</span><br><span class="line">   <span class="comment">// No longer need the local reference, free it!</span></span><br><span class="line">   (*env)-&gt;DeleteLocalRef(env, classIntegerLocal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>必须要注意 jmethodID 和 jfieldID 不是 jobject，不能创建全局引用。</p>
<h2 id="JNI-Common-Errors"><a href="#JNI-Common-Errors" class="headerlink" title="JNI Common Errors"></a>JNI Common Errors</h2><blockquote>
<p>ERROR MESSAGE: SEVERE: java.lang.UnsatisfiedLinkError: no xxx in java.library.path<br>PROBABLE CAUSES: Your program uses a native library from a 3rd-party API (such as JOGL),<br>   which cannot be located in the native library search paths.<br>POSSIBLE SOLUTION:<br>A Java Native Library (JNI) contains non-Java library codes (in filetype of “.dll” in Windows, “.so” in Linux,<br>   “.jnilib” in MacOS). For example, JOGL’s “jogl_xxx.dll”, “gluegen-rt.dll”.<br>   These dll’s are needed for proper operations.<br>The directory path of native libraries must be included in Java system’s property “java.library.path”.<br>The “java.library.path” usually mirrors the Envrionment Variable PATH. You can list the entries by issuing:<br>   System.out.println(System.getProperty(“java.library.path”));</p>
<p>To include a directory in “java.library.path”, you can use VM command-line option -Djava.library.path=pathname<br>For JRE:</p>
<blockquote>
<p>java -Djava.library.path=d:\bin\jogl2.0\lib myjoglapp</p>
</blockquote>
<p>For Eclipse, the VM command-line option can be set in “Run Configuration…” ⇒ “Arguments” ⇒ “VM Arguments”.<br>Alternatively, you can create a User library and specifying the native library (Refer to “Eclipse How-To”)</p>
<p>For NetBeans, the VM command-line option can be set in “Set Configuration” ⇒ “Customize…” ⇒ “Run” ⇒ “VM options”.</p>
</blockquote>
<h2 id="JNI-程序的-Debug"><a href="#JNI-程序的-Debug" class="headerlink" title="JNI 程序的 Debug"></a>JNI 程序的 Debug</h2><p>[TODO]</p>
<h2 id="Reference-amp-Resources"><a href="#Reference-amp-Resources" class="headerlink" title="Reference &amp; Resources"></a>Reference &amp; Resources</h2><ol>
<li>Java Native Interface Specification @ <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/7/docs/technotes/guides/jni/index.html">http://docs.oracle.com/javase/7/docs/technotes/guides/jni/index.html</a>.</li>
<li>Wiki “Java Native Interface” @ <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Java_Native_Interface">http://en.wikipedia.org/wiki/Java_Native_Interface</a>.</li>
<li>Liang, “The Java Native Interface - Programmer’s Guide and Specification”, Addison Wesley, 1999, available online @ <a target="_blank" rel="noopener" href="http://java.sun.com/docs/books/jni/html/jniTOC.html">http://java.sun.com/docs/books/jni/html/jniTOC.html</a>.</li>
<li>JNI Tips @ <a target="_blank" rel="noopener" href="http://developer.android.com/guide/practices/jni.html">http://developer.android.com/guide/practices/jni.html</a>.</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JDK/" rel="tag"># JDK</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2020/01/12/JNI-tutorial-%E2%85%A1/" rel="next" title="JNI-tutorial-Ⅱ">
      JNI-tutorial-Ⅱ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Getting-Started"><span class="nav-text">Getting Started</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-%E4%B8%8E-C-%E8%AF%AD%E8%A8%80"><span class="nav-text">JNI 与 C 语言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-%E4%B8%8E-C-%E8%AF%AD%E8%A8%80-1"><span class="nav-text">JNI 与 C++ 语言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-%E4%B8%8E-C-C-%E8%AF%AD%E8%A8%80"><span class="nav-text">JNI 与 C&#x2F;C++ 语言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-in-Package"><span class="nav-text">JNI in Package</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-in-Module-JDK-9"><span class="nav-text">JNI in Module (JDK 9)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-in-Eclipse"><span class="nav-text">JNI in Eclipse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-in-NetBeans"><span class="nav-text">JNI in NetBeans</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI-%E5%9F%BA%E7%A1%80"><span class="nav-text">JNI 基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8-Java-%E7%BC%96%E7%A8%8B-%E5%92%8C-Native-%E7%BC%96%E7%A8%8B%E4%B9%8B%E9%97%B4%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0%E5%92%8C%E7%BB%93%E6%9E%9C"><span class="nav-text">在 Java 编程 和 Native 编程之间传递参数和结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Primitive-%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92"><span class="nav-text">Primitive 类型数据传递</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String-%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92"><span class="nav-text">String 类型数据传递</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Array-of-Primitives-%E4%BC%A0%E9%80%92"><span class="nav-text">Array of Primitives 传递</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8F%98%E9%87%8F%E4%BB%A5%E5%8F%8A%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95"><span class="nav-text">访问对象的变量以及回调方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F"><span class="nav-text">访问对象的实例变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E7%B1%BB%E7%9A%84%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F"><span class="nav-text">访问类的静态变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E5%92%8C%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="nav-text">回调实例方法和静态方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E7%88%B6%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95"><span class="nav-text">回调父类的实例方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%95%B0%E7%BB%84"><span class="nav-text">创建对象和数组</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-Native-%E4%BB%A3%E7%A0%81%E4%B8%AD%E8%B0%83%E7%94%A8%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84-Java-%E5%AF%B9%E8%B1%A1"><span class="nav-text">在 Native 代码中调用构造函数创建新的 Java 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E6%95%B0%E7%BB%84"><span class="nav-text">对象数组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%92%8C%E5%85%A8%E5%B1%80%E5%BC%95%E7%94%A8"><span class="nav-text">本地和全局引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI-Common-Errors"><span class="nav-text">JNI Common Errors</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI-%E7%A8%8B%E5%BA%8F%E7%9A%84-Debug"><span class="nav-text">JNI 程序的 Debug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference-amp-Resources"><span class="nav-text">Reference &amp; Resources</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="FFYzz"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">FFYzz</p>
  <div class="site-description" itemprop="description">在自我鄙视中一步一步往上爬</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/FFYzz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;FFYzz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cryptochen95@gmail.com" title="E-Mail → mailto:cryptochen95@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FFYzz</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://littleF.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://ffyzz.github.io/2020/01/07/JNI-tutorial-%E2%85%A0/";
    this.page.identifier = "2020/01/07/JNI-tutorial-Ⅰ/";
    this.page.title = "JNI tutorial Ⅰ";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://littleF.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
